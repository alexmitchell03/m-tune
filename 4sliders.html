<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tune the Orchestra</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h1>Tune the Orchestra</h1>
    <h2>Given a note to find, put the slider in tune with the note</h2>
    <div class="slider-container">
        <input type="range" min="-50" max="50" value="0" class="slider" id="pitchSlider1" orient="vertical" step="10">
        <input type="range" min="-50" max="50" value="0" class="slider" id="pitchSlider2" orient="vertical" step="10">
        <input type="range" min="-50" max="50" value="0" class="slider" id="pitchSlider3" orient="vertical" step="10">
        <input type="range" min="-50" max="50" value="0" class="slider" id="pitchSlider4" orient="vertical" step="10">
    </div>
    <div class="pitch-container">
        <span id="pitchValue1">0</span> cents
        <br>
        <button onclick="playAudio1()">Play Instrument 1</button>
        <button onclick="stopAudio1()">Stop Instrument 1</button>
        <div id="goalPitch1">Instrument 1 Goal Pitch</div>
        <div id="goalPitch1-2">Instrument 1 Real Goal Pitch</div>
        <div id="currentPitch1">Instrument 1 Current Pitch</div>

        <span id="pitchValue2">0</span> cents
        <br>
        <button onclick="playAudio2()">Play Instrument 2</button>
        <button onclick="stopAudio2()">Stop Instrument 2</button>
        <div id="goalPitch2">Instrument 2 Goal Pitch</div>
        <div id="goalPitch2-2">Instrument 2 Real Goal Pitch</div>
        <div id="currentPitch2">Instrument 2 Current Pitch</div>

        <span id="pitchValue3">0</span> cents
        <br>
        <button onclick="playAudio3()">Play Instrument 3</button>
        <button onclick="stopAudio3()">Stop Instrument 3</button>
        <div id="goalPitch3">Instrument 3 Goal Pitch</div>
        <div id="goalPitch3-2">Instrument 3 Real Goal Pitch</div>
        <div id="currentPitch3">Instrument 3 Current Pitch</div>

        <span id="pitchValue4">0</span> cents
        <br>
        <button onclick="playAudio4()">Play Instrument 4</button>
        <button onclick="stopAudio4()">Stop Instrument 4</button>
        <div id="goalPitch4">Instrument 4 Goal Pitch</div>
        <div id="goalPitch4-2">Instrument 4 Real Goal Pitch</div>
        <div id="currentPitch4">Instrument 4 Current Pitch</div>
    </div>
    <div class="emh-button">
        <button onclick="setMode('easy')">Easy Mode</button>
        <button onclick="setMode('medium')">Medium Mode</button>
        <button onclick="setMode('hard')">Hard Mode</button>
        <button onclick="checkPitch()">Check Pitch</button> Button for checking user's pitch
        <div id="result"></div>
    </div>
    <!-- <div id="spinner"></div> -->

    <script>    
        let audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let audioSource1 = null;
        let audioSource2 = null;
        let audioSource3 = null;
        let audioSource4 = null;
        const basePitch = 196.00; //G3 frequency

        // Calculate a random goal pitch within the G3 to G5 range
        const randomGoalNote1 = Math.floor(Math.random() * 24); // Random note number from G3 to G5
        const randomGoalFrequency1 = basePitch * Math.pow(2, randomGoalNote / 12); // Corresponding frequency
        const randomGoalNote2 = Math.floor(Math.random() * 24); // Random note number from G3 to G5
        const randomGoalFrequency2 = basePitch * Math.pow(2, randomGoalNote / 12); // Corresponding frequency
        const randomGoalNote3 = Math.floor(Math.random() * 24); // Random note number from G3 to G5
        const randomGoalFrequency3 = basePitch * Math.pow(2, randomGoalNote / 12); // Corresponding frequency
        const randomGoalNote4 = Math.floor(Math.random() * 24); // Random note number from G3 to G5
        const randomGoalFrequency4 = basePitch * Math.pow(2, randomGoalNote / 12); // Corresponding frequency

        // Calculate an initial pitch within Â±50 cents from the goal pitch
        const randomInitPitch1 = randomGoalFrequency * Math.pow(2, ((Math.random() * 100) - 50) / 1200);
        const randomInitPitch2 = randomGoalFrequency * Math.pow(2, ((Math.random() * 100) - 50) / 1200);
        const randomInitPitch3 = randomGoalFrequency * Math.pow(2, ((Math.random() * 100) - 50) / 1200);
        const randomInitPitch4 = randomGoalFrequency * Math.pow(2, ((Math.random() * 100) - 50) / 1200);

        function hertzToNote(hertz) {
            const notes = ["A", "A#", "B", "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#"];
            const HERTZOFC0 = 16.35; // Lowest C note (C0) frequency in Hz
            const OCTAVE_OFFSET = 0; // Starting octave number for representation (adjust as needed)

            const halfSteps = Math.round(12 * Math.log2(hertz / HERTZOFC0));
            const octave = Math.floor((halfSteps + 3) / 12) + OCTAVE_OFFSET;
            const note = notes[(halfSteps + 3) % 12];

            return note + octave;
        }

        function setMode(mode) {
            const pitchSlider1 = document1.getElementById('pitchSlider1');
            const pitchValueDisplay1 = document1.getElementById('pitchValue1');
            const pitchSlider2 = document2.getElementById('pitchSlider2');
            const pitchValueDisplay2 = document2.getElementById('pitchValue2');
            const pitchSlider3 = document3.getElementById('pitchSlider3');
            const pitchValueDisplay3 = document3.getElementById('pitchValue3');
            const pitchSlider4 = document4.getElementById('pitchSlider4');
            const pitchValueDisplay4 = document4.getElementById('pitchValue4');
            const basePitch = 196.00; //G3 frequency
            const randomGoalNote1 = Math.floor(Math.random() * 24); // Random note number from G3 to G5
            const randomGoalFrequency1 = basePitch * Math.pow(2, randomGoalNote / 12); // Corresponding frequency
            const randomGoalNote2 = Math.floor(Math.random() * 24); // Random note number from G3 to G5
            const randomGoalFrequency2 = basePitch * Math.pow(2, randomGoalNote / 12); // Corresponding frequency
            const randomGoalNote3 = Math.floor(Math.random() * 24); // Random note number from G3 to G5
            const randomGoalFrequency3 = basePitch * Math.pow(2, randomGoalNote / 12); // Corresponding frequency
            const randomGoalNote4 = Math.floor(Math.random() * 24); // Random note number from G3 to G5
            const randomGoalFrequency4 = basePitch * Math.pow(2, randomGoalNote / 12); // Corresponding frequency
            let initialPitch1 = 0;
            let initialPitch2 = 0;
            let initialPitch3 = 0;
            let initialPitch4 = 0;

            if (mode === 'easy') {
                initialPitch1 = randomGoalFrequency * Math.pow(2, ((Math.random() * 10) - 5) / 120); // Multiple of 10 off the goal pitch
                pitchSlider1.step = '10'; // Set step to 10 for easy mode
                initialPitch2 = randomGoalFrequency * Math.pow(2, ((Math.random() * 10) - 5) / 120); // Multiple of 10 off the goal pitch
                pitchSlider2.step = '10'; // Set step to 10 for easy mode
                initialPitch3 = randomGoalFrequency * Math.pow(2, ((Math.random() * 10) - 5) / 120); // Multiple of 10 off the goal pitch
                pitchSlider3.step = '10'; // Set step to 10 for easy mode
                initialPitch4 = randomGoalFrequency * Math.pow(2, ((Math.random() * 10) - 5) / 120); // Multiple of 10 off the goal pitch
                pitchSlider4.step = '10'; // Set step to 10 for easy mode
            } else if (mode === 'hard') {
                initialPitch1 = randomGoalFrequency * Math.pow(2, ((Math.random() * 100) - 50) / 1200); // Original logic for hard mode
                pitchSlider1.step = '1'; // Set step to 1 for hard mode
                initialPitch2 = randomGoalFrequency * Math.pow(2, ((Math.random() * 100) - 50) / 1200); // Original logic for hard mode
                pitchSlider2.step = '1'; // Set step to 1 for hard mode
                initialPitch3 = randomGoalFrequency * Math.pow(2, ((Math.random() * 100) - 50) / 1200); // Original logic for hard mode
                pitchSlider3.step = '1'; // Set step to 1 for hard mode
                initialPitch4 = randomGoalFrequency * Math.pow(2, ((Math.random() * 100) - 50) / 1200); // Original logic for hard mode
                pitchSlider4.step = '1'; // Set step to 1 for hard mode
            }

            pitchSlider1.value = ((Math.log2(initialPitch / randomGoalFrequency)) * 1200).toFixed(2);
            pitchValueDisplay1.textContent = pitchSlider1.value;
            pitchSlider2.value = ((Math.log2(initialPitch / randomGoalFrequency)) * 1200).toFixed(2);
            pitchValueDisplay2.textContent = pitchSlider2.value;
            pitchSlider3.value = ((Math.log2(initialPitch / randomGoalFrequency)) * 1200).toFixed(2);
            pitchValueDisplay3.textContent = pitchSlider3.value;
            pitchSlider4.value = ((Math.log2(initialPitch / randomGoalFrequency)) * 1200).toFixed(2);
            pitchValueDisplay4.textContent = pitchSlider4.value;
        }


        function playAudio1() {
            if (!audioSource1) {
                const audioFilePath = '/Alesis-Fusion-Violin-C5.wav'; // Replace with the path to your .wav file
                const audioBufferSourceNode = audioContext.createBufferSource();

                // Fetch the audio file
                fetch(audioFilePath)
                    .then(response => response.arrayBuffer())
                    .then(buffer => audioContext.decodeAudioData(buffer))
                    .then(decodedBuffer => {
                        audioBufferSourceNode.buffer = decodedBuffer;
                        audioBufferSourceNode.connect(audioContext.destination);
                        audioBufferSourceNode.start();
                        audioSource1 = audioBufferSourceNode;
                    })
                    .catch(error => console.error('Error loading audio file:', error));
            }
        }

        function updatePitch1(randomInitPitch1) {
            if (audioSource1) {
                const cents = parseFloat(pitchSlider1.value);
                const frequencyMultiplier = Math.pow(2, cents / 1200); // Convert slider position to frequency multiplier

                const initialFrequency = randomInitPitch1 * frequencyMultiplier;

                oscillator.frequency.setValueAtTime(initialFrequency, audioContext.currentTime);
                pitchValueDisplay.textContent = cents; // Display cents range from -50 to 50

                const goalPitchDiv = document.getElementById('goalPitch');
                const goalPitchDiv2 = document.getElementById('goalPitch2');
                const noteRepresentation = hertzToNote(randomGoalFrequency1);
                goalPitchDiv.textContent = 'Goal Pitch: ' + noteRepresentation;
                goalPitchDiv2.textContent = 'Real Goal Pitch: ' + randomGoalFrequency1.toFixed(2) + ' Hz';
                
                const currentPitchDiv = document.getElementById('currentPitch');
                const currentFrequency = initialFrequency.toFixed(2);
                currentPitchDiv.textContent = 'Current Pitch: ' + currentFrequency + ' Hz';
            }
        }

        function stopAudio1() {
            if (audioSource1) {
                audioSource1.stop();
                audioSource1.disconnect();
                audioSource1 = null;
            }
        }

        function checkPitch1() {
            if (audioSource1) {
                const cents = parseFloat(pitchSlider1.value);
                const frequencyMultiplier = Math.pow(2, cents / 1200); // Convert slider position to frequency multiplier

                const initialFrequency = randomInitPitch1 * frequencyMultiplier;

                const goalPitchDiv = document.getElementById('goalPitch');
                const currentPitchDiv = document.getElementById('currentPitch');
                const resultDiv = document.getElementById('result');

                const differenceCents = Math.abs(1200 * Math.log2(initialFrequency / randomGoalFrequency1)); // Calculate difference in cents

                if (Math.abs(randomGoalFrequency1 - initialFrequency) <= 0.4) {
                    resultDiv.textContent = 'Correct! You have a good ear!';
                } else {
                    resultDiv.textContent = `Incorrect. You were off by approximately ${differenceCents.toFixed(2)} cents.`;
                }
            }
        }

        function playAudio2() {
            if (!audioSource2) {
                const audioFilePath = '/Alesis-S4-Plus-SopranoSax-C5.wav'; // Replace with the path to your .wav file
                const audioBufferSourceNode = audioContext.createBufferSource();

                // Fetch the audio file
                fetch(audioFilePath)
                    .then(response => response.arrayBuffer())
                    .then(buffer => audioContext.decodeAudioData(buffer))
                    .then(decodedBuffer => {
                        audioBufferSourceNode.buffer = decodedBuffer;
                        audioBufferSourceNode.connect(audioContext.destination);
                        audioBufferSourceNode.start();
                        audioSource2 = audioBufferSourceNode;
                    })
                    .catch(error => console.error('Error loading audio file:', error));
            }
        }

        function updatePitch2(randomInitPitch2) {
            if (audioSource2) {
                const cents = parseFloat(pitchSlider2.value);
                const frequencyMultiplier = Math.pow(2, cents / 1200); // Convert slider position to frequency multiplier

                const initialFrequency = randomInitPitch2 * frequencyMultiplier;

                oscillator.frequency.setValueAtTime(initialFrequency, audioContext.currentTime);
                pitchValueDisplay.textContent = cents; // Display cents range from -50 to 50

                const goalPitchDiv = document.getElementById('goalPitch');
                const goalPitchDiv2 = document.getElementById('goalPitch2');
                const noteRepresentation = hertzToNote(randomGoalFrequency2);
                goalPitchDiv.textContent = 'Goal Pitch: ' + noteRepresentation;
                goalPitchDiv2.textContent = 'Real Goal Pitch: ' + randomGoalFrequency2.toFixed(2) + ' Hz';
                
                const currentPitchDiv = document.getElementById('currentPitch');
                const currentFrequency = initialFrequency.toFixed(2);
                currentPitchDiv.textContent = 'Current Pitch: ' + currentFrequency + ' Hz';
            }
        }

        function stopAudio2() {
            if (audioSource2) {
                audioSource2.stop();
                audioSource2.disconnect();
                audioSource2 = null;
            }
        }

        function checkPitch2() {
            if (audioSource2) {
                const cents = parseFloat(pitchSlider2.value);
                const frequencyMultiplier = Math.pow(2, cents / 1200); // Convert slider position to frequency multiplier

                const initialFrequency = randomInitPitch2 * frequencyMultiplier;

                const goalPitchDiv = document.getElementById('goalPitch');
                const currentPitchDiv = document.getElementById('currentPitch');
                const resultDiv = document.getElementById('result');

                const differenceCents = Math.abs(1200 * Math.log2(initialFrequency / randomGoalFrequency2)); // Calculate difference in cents

                if (Math.abs(randomGoalFrequency2 - initialFrequency) <= 0.4) {
                    resultDiv.textContent = 'Correct! You have a good ear!';
                } else {
                    resultDiv.textContent = `Incorrect. You were off by approximately ${differenceCents.toFixed(2)} cents.`;
                }
            }
        }

        function playAudio3() {
            if (!audioSource3) {
                const audioFilePath = '/E-Mu-Proteus-2-Flute-C5.wav'; // Replace with the path to your .wav file
                const audioBufferSourceNode = audioContext.createBufferSource();

                // Fetch the audio file
                fetch(audioFilePath)
                    .then(response => response.arrayBuffer())
                    .then(buffer => audioContext.decodeAudioData(buffer))
                    .then(decodedBuffer => {
                        audioBufferSourceNode.buffer = decodedBuffer;
                        audioBufferSourceNode.connect(audioContext.destination);
                        audioBufferSourceNode.start();
                        audioSource3 = audioBufferSourceNode;
                    })
                    .catch(error => console.error('Error loading audio file:', error));
            }
        }

        function updatePitch3(randomInitPitch3) {
            if (audioSource3) {
                const cents = parseFloat(pitchSlider3.value);
                const frequencyMultiplier = Math.pow(2, cents / 1200); // Convert slider position to frequency multiplier

                const initialFrequency = randomInitPitch3 * frequencyMultiplier;

                oscillator.frequency.setValueAtTime(initialFrequency, audioContext.currentTime);
                pitchValueDisplay.textContent = cents; // Display cents range from -50 to 50

                const goalPitchDiv = document.getElementById('goalPitch');
                const goalPitchDiv2 = document.getElementById('goalPitch2');
                const noteRepresentation = hertzToNote(randomGoalFrequency3);
                goalPitchDiv.textContent = 'Goal Pitch: ' + noteRepresentation;
                goalPitchDiv2.textContent = 'Real Goal Pitch: ' + randomGoalFrequency3.toFixed(2) + ' Hz';
                
                const currentPitchDiv = document.getElementById('currentPitch');
                const currentFrequency = initialFrequency.toFixed(2);
                currentPitchDiv.textContent = 'Current Pitch: ' + currentFrequency + ' Hz';
            }
        }

        function stopAudio3() {
            if (audioSource3) {
                audioSource3.stop();
                audioSource3.disconnect();
                audioSource3 = null;
            }
        }

        function checkPitch3() {
            if (audioSource3) {
                const cents = parseFloat(pitchSlider3.value);
                const frequencyMultiplier = Math.pow(2, cents / 1200); // Convert slider position to frequency multiplier

                const initialFrequency = randomInitPitch3 * frequencyMultiplier;

                const goalPitchDiv = document.getElementById('goalPitch');
                const currentPitchDiv = document.getElementById('currentPitch');
                const resultDiv = document.getElementById('result');

                const differenceCents = Math.abs(1200 * Math.log2(initialFrequency / randomGoalFrequency3)); // Calculate difference in cents

                if (Math.abs(randomGoalFrequency3 - initialFrequency) <= 0.4) {
                    resultDiv.textContent = 'Correct! You have a good ear!';
                } else {
                    resultDiv.textContent = `Incorrect. You were off by approximately ${differenceCents.toFixed(2)} cents.`;
                }
            }
        }

        function playAudio4() {
            if (!audioSource4) {
                const audioFilePath = '/Ensoniq-SQ-1-Trumpet-C3.wav'; // Replace with the path to your .wav file
                const audioBufferSourceNode = audioContext.createBufferSource();

                // Fetch the audio file
                fetch(audioFilePath)
                    .then(response => response.arrayBuffer())
                    .then(buffer => audioContext.decodeAudioData(buffer))
                    .then(decodedBuffer => {
                        audioBufferSourceNode.buffer = decodedBuffer;
                        audioBufferSourceNode.connect(audioContext.destination);
                        audioBufferSourceNode.start();
                        audioSource4 = audioBufferSourceNode;
                    })
                    .catch(error => console.error('Error loading audio file:', error));
            }
        }

        function updatePitch4(randomInitPitch4) {
            if (audioSource4) {
                const cents = parseFloat(pitchSlider4.value);
                const frequencyMultiplier = Math.pow(2, cents / 1200); // Convert slider position to frequency multiplier

                const initialFrequency = randomInitPitch4 * frequencyMultiplier;

                oscillator.frequency.setValueAtTime(initialFrequency, audioContext.currentTime);
                pitchValueDisplay.textContent = cents; // Display cents range from -50 to 50

                const goalPitchDiv = document.getElementById('goalPitch');
                const goalPitchDiv2 = document.getElementById('goalPitch2');
                const noteRepresentation = hertzToNote(randomGoalFrequency4);
                goalPitchDiv.textContent = 'Goal Pitch: ' + noteRepresentation;
                goalPitchDiv2.textContent = 'Real Goal Pitch: ' + randomGoalFrequency4.toFixed(2) + ' Hz';
                
                const currentPitchDiv = document.getElementById('currentPitch');
                const currentFrequency = initialFrequency.toFixed(2);
                currentPitchDiv.textContent = 'Current Pitch: ' + currentFrequency + ' Hz';
            }
        }

        function stopAudio4() {
            if (audioSource4) {
                audioSource4.stop();
                audioSource4.disconnect();
                audioSource4 = null;
            }
        }

        function checkPitch4() {
            if (audioSource4) {
                const cents = parseFloat(pitchSlider4.value);
                const frequencyMultiplier = Math.pow(2, cents / 1200); // Convert slider position to frequency multiplier

                const initialFrequency = randomInitPitch4 * frequencyMultiplier;

                const goalPitchDiv = document.getElementById('goalPitch');
                const currentPitchDiv = document.getElementById('currentPitch');
                const resultDiv = document.getElementById('result');

                const differenceCents = Math.abs(1200 * Math.log2(initialFrequency / randomGoalFrequency4)); // Calculate difference in cents

                if (Math.abs(randomGoalFrequency4 - initialFrequency) <= 0.4) {
                    resultDiv.textContent = 'Correct! You have a good ear!';
                } else {
                    resultDiv.textContent = `Incorrect. You were off by approximately ${differenceCents.toFixed(2)} cents.`;
                }
            }
        }

        // Set the initial value and range of the slider
        pitchSlider1.value = 0; // Set the slider value to the center (0)
        pitchSlider1.min = -50; // Set the minimum value of the slider
        pitchSlider1.max = 50; // Set the maximum value of the slider
        pitchSlider2.value = 0; // Set the slider value to the center (0)
        pitchSlider2.min = -50; // Set the minimum value of the slider
        pitchSlider2.max = 50; // Set the maximum value of the slider
        pitchSlider3.value = 0; // Set the slider value to the center (0)
        pitchSlider3.min = -50; // Set the minimum value of the slider
        pitchSlider3.max = 50; // Set the maximum value of the slider
        pitchSlider4.value = 0; // Set the slider value to the center (0)
        pitchSlider4.min = -50; // Set the minimum value of the slider
        pitchSlider4.max = 50; // Set the maximum value of the slider
    </script>
</body>
</html>